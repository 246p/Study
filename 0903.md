# TODO
- 9009 patch, UAF 검증
- 6359 patch, UAF 검증
- 9165 patch
- 7868 왜 UAF라 나오는지
- BOF bug 하나 추가
# build_patch 수정
``` sh
# build.sh
## if문 도입하여 하나의 script만 사용
...
if [ $# -eq 1 ]; then 사용
  patch -p2 < $1
fi
...

```

# libming-4.8
- target commit : 7fed3147
- sanitizer on, ASAN_OPTIONS=detect_leaks=0,allocator_may_return_null=1
## UAF
### CVE-2018-9009
1. report : https://github.com/libming/libming/issues/131
2. poc : https://github.com/libming/libming/files/1844936/libming_0-4-8_swftophp_heap-use-after-free_decompileJUMP.swf.zip
3. target : decompile.c:1843
4. stack strace
``` log
==6851==ERROR: AddressSanitizer: heap-use-after-free on address 0x607000000120 at pc 0x00000050f613 bp 0x7fff4b1c1890 sp 0x7fff4b1c1888
READ of size 1 at 0x607000000120 thread T0
[Detaching after fork from child process 6855]
    #0 0x50f612 in decompileJUMP /workspace/libming-4.8/BUILD/util/decompile.c:1843:64
    #1 0x50b966 in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3237:10
    #2 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #3 0x518f5a in decompile5Action /workspace/libming-4.8/BUILD/util/decompile.c:3428:2
    #4 0x503d04 in outputSWF_DOACTION /workspace/libming-4.8/BUILD/util/outputscript.c:1548:29
    #5 0x501c3c in outputBlock /workspace/libming-4.8/BUILD/util/outputscript.c:2079:4
    #6 0x5095c6 in readMovie /workspace/libming-4.8/BUILD/util/main.c:286:4
    #7 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #8 0x7fd9ce593082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16
    #9 0x41c44d in _start (/benchmark/bin/vanilla/swftophp-common+0x41c44d)

0x607000000120 is located 32 bytes inside of 80-byte region [0x607000000100,0x607000000150)
```
5. patch
``` diff



```
### CVE-2018-6359
1. report : https://github.com/libming/libming/issues/105
2. poc : https://github.com/libming/libming/files/1670002/free_decompileIF.zip
3. target : decompile.c:868 (OpCode, call site가 103개)
4. stack strace
``` log
==2541==ERROR: AddressSanitizer: heap-use-after-free on address 0x60e0000000d0 at pc 0x00000051a061 bp 0x7fff39baf2a0 sp 0x7fff39baf298
READ of size 1 at 0x60e0000000d0 thread T0
[Detaching after fork from child process 2549]
    #0 0x51a060 in OpCode /workspace/libming-4.8/BUILD/util/decompile.c:868:37
    #1 0x51be60 in isLogicalOp /workspace/libming-4.8/BUILD/util/decompile.c:1193:9
    #2 0x51147f in decompileIF /workspace/libming-4.8/BUILD/util/decompile.c:2337:6
    #3 0x50b9af in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3247:10
    #4 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #5 0x518f5a in decompile5Action /workspace/libming-4.8/BUILD/util/decompile.c:3428:2
    #6 0x503d04 in outputSWF_DOACTION /workspace/libming-4.8/BUILD/util/outputscript.c:1548:29
    #7 0x501c3c in outputBlock /workspace/libming-4.8/BUILD/util/outputscript.c:2079:4
    #8 0x5095c6 in readMovie /workspace/libming-4.8/BUILD/util/main.c:286:4
    #9 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #10 0x7fd07440f082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16
    #11 0x41c44d in _start (/benchmark/bin/vanilla/swftophp-common+0x41c44d)

0x60e0000000d0 is located 144 bytes inside of 160-byte region [0x60e000000040,0x60e0000000e0)
```
5. patch : 
## ND
### CVE-2018-9132(20427)
- 20427의 poc경우 ASAN을 켰을때 `allocator_may_return_null=1` option을 주어야 trigger 됨 그렇지 않으면 다음과 같은 오류 발생
``` log
==6090==ERROR: AddressSanitizer: requested allocation size 0xfffffffffffcb200 (0xfffffffffffcc200 after adjustments for alignment, red zones etc.) exceeds maximum supported size of 0x10000000000 (thread T0)
    #0 0x4c156f in malloc /fuzzer/AFLGo/instrument/llvm_tools/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3
    #1 0x523d3c in parseSWF_ACTIONRECORD /workspace/libming-4.8/BUILD/util/parser.c:1142:27
    #2 0x543305 in parseSWF_DOACTION /workspace/libming-4.8/BUILD/util/parser.c:2434:7
    #3 0x509e89 in blockParse /workspace/libming-4.8/BUILD/util/blocktypes.c:145:14
    #4 0x5094dd in readMovie /workspace/libming-4.8/BUILD/util/main.c:274:11
    #5 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #6 0x7fe06641f082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16

==6090==HINT: if you don't care about these errors you may set allocator_may_return_null=1
SUMMARY: AddressSanitizer: allocation-size-too-big /fuzzer/AFLGo/instrument/llvm_tools/compiler-rt/lib/asan/asan_malloc_linux.cpp:145:3 in malloc
==6090==ABORTING
```
1. report : https://github.com/libming/libming/issues/133, https://github.com/libming/libming/issues/164
2. poc : https://github.com/libming/libming/files/1860635/libming_0-4-8_swftophp_null-pointer-dereference_getInt.swf.zip, https://github.com/libming/libming/files/2404664/segmentaion_fault_decompile_477.zip
3. target : decompile.c:425
4. stack strace
``` log 
==10729==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000010 (pc 0x00000051b218 bp 0x7fff5be1c800 sp 0x7fff5be1c780 T0)
==10729==The signal is caused by a READ memory access.
==10729==Hint: address points to the zero page.
    #0 0x51b218 in getInt /workspace/libming-4.8/BUILD/util/decompile.c:425:15
    #1 0x51b334 in getInt /workspace/libming-4.8/BUILD/util/decompile.c:432:10
    #2 0x50cd9d in decompileGETPROPERTY /workspace/libming-4.8/BUILD/util/decompile.c:1390:47
    #3 0x50b799 in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3172:3
    #4 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #5 0x518f5a in decompile5Action /workspace/libming-4.8/BUILD/util/decompile.c:3428:2
    #6 0x503d04 in outputSWF_DOACTION /workspace/libming-4.8/BUILD/util/outputscript.c:1548:29
    #7 0x501c3c in outputBlock /workspace/libming-4.8/BUILD/util/outputscript.c:2079:4
    #8 0x5095c6 in readMovie /workspace/libming-4.8/BUILD/util/main.c:286:4
    #9 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #10 0x7f3c3999a082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16
    #11 0x41c44d in _start (/benchmark/bin/vanilla/swftophp-common+0x41c44d)

```
5. patch1
``` diff
--- SRC/util/decompile.c	2024-08-22 11:47:10.765046270 +0000
+++ 201820427/util/decompile.c	2024-08-22 11:46:29.653592507 +0000
@@ -429,7 +429,13 @@
 	case PUSH_NULL: /* NULL */
 		return 0;
 	case PUSH_REGISTER: /* REGISTER */
-		return getInt(regs[act->p.RegisterNumber]);
+		if( regs[act->p.RegisterNumber] )
+			return getInt(regs[act->p.RegisterNumber]);
+	    else
+		{
+				SWF_warn("WARNING: retrieving undefined register values.\n");
+				break;
+		}
 	case PUSH_DOUBLE: /* DOUBLE */
 		return (int)act->p.Double;
 	case PUSH_INT: /* INTEGER */
```
### CVE-2018-9165
1. report : https://github.com/libming/libming/issues/121
2. poc : https://github.com/fantasy7082/image_test/blob/master/013-NULL-ptr-swf
3. target : decompile.c:380
4. stack strace
``` log
==12857==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000000 (pc 0x7f8d0f756915 bp 0x7fff09669790 sp 0x7fff09668f28 T0)
==12857==The signal is caused by a READ memory access.
==12857==Hint: address points to the zero page.
    #0 0x7f8d0f756915  /build/glibc-LcI20x/glibc-2.31/string/../sysdeps/x86_64/multiarch/strlen-avx2.S:65
    #1 0x46db4c in __interceptor_strlen.part.0 /fuzzer/AFLGo/instrument/llvm_tools/compiler-rt/lib/asan/../sanitizer_common/sanitizer_common_interceptors.inc:370:31
    #2 0x51a623 in getName /workspace/libming-4.8/BUILD/util/decompile.c:380:12
    #3 0x51682d in decompileCALLMETHOD /workspace/libming-4.8/BUILD/util/decompile.c:2851:18
    #4 0x50ba79 in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3272:10
    #5 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #6 0x518f5a in decompile5Action /workspace/libming-4.8/BUILD/util/decompile.c:3428:2
    #7 0x4fc694 in outputSWF_DEFINEBUTTON2 /workspace/libming-4.8/BUILD/util/outputscript.c:932:2
    #8 0x501c3c in outputBlock /workspace/libming-4.8/BUILD/util/outputscript.c:2079:4
    #9 0x5095c6 in readMovie /workspace/libming-4.8/BUILD/util/main.c:286:4
    #10 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #11 0x7f8d0f5f2082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16
    #12 0x41c44d in _start (/benchmark/bin/vanilla/swftophp-common+0x41c44d)
```
5. patch : 
## BOF
### CVE-2018-7868 (ASAN상으론 heap UAF)
1. report : https://github.com/libming/libming/issues/113
2. poc : https://github.com/fantasy7082/image_test/blob/master/005-heap-over-swf
3. target : decompile.c:398
4. stack strace
``` log
==7601==ERROR: AddressSanitizer: heap-use-after-free on address 0x60b0000008e0 at pc 0x00000051a744 bp 0x7ffec4861c90 sp 0x7ffec4861c88
READ of size 8 at 0x60b0000008e0 thread T0
    #0 0x51a743 in getName /workspace/libming-4.8/BUILD/util/decompile.c:398:22
    #1 0x50d2cc in decompileGETMEMBER /workspace/libming-4.8/BUILD/util/decompile.c:1621:10
    #2 0x50b86d in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3203:3
    #3 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #4 0x51538e in decompileDEFINEFUNCTION /workspace/libming-4.8/BUILD/util/decompile.c:2745:3
    #5 0x50ba4b in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3266:10
    #6 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #7 0x5139be in decompileIF /workspace/libming-4.8/BUILD/util/decompile.c:2567:4
    #8 0x50b9af in decompileAction /workspace/libming-4.8/BUILD/util/decompile.c:3247:10
    #9 0x5190f5 in decompileActions /workspace/libming-4.8/BUILD/util/decompile.c:3406:6
    #10 0x518f5a in decompile5Action /workspace/libming-4.8/BUILD/util/decompile.c:3428:2
    #11 0x5059c4 in outputSWF_INITACTION /workspace/libming-4.8/BUILD/util/outputscript.c:1858:11
    #12 0x501c3c in outputBlock /workspace/libming-4.8/BUILD/util/outputscript.c:2079:4
    #13 0x5095c6 in readMovie /workspace/libming-4.8/BUILD/util/main.c:286:4
    #14 0x508517 in main /workspace/libming-4.8/BUILD/util/main.c:359:2
    #15 0x7f384bc4a082 in __libc_start_main /build/glibc-LcI20x/glibc-2.31/csu/../csu/libc-start.c:308:16
    #16 0x41c44d in _start (/benchmark/bin/vanilla/swftophp-common+0x41c44d)

0x60b0000008e4 is located 0 bytes to the right of 100-byte region [0x60b000000880,0x60b0000008e4

```
5. patch : 
``` diff
--- SRC/util/decompile.c	2024-08-22 12:16:19.965767739 +0000
+++ 20187868/util/decompile.c	2024-08-22 12:19:24.893527981 +0000
@@ -46,6 +46,7 @@
 
 
 static char **pool;
+static unsigned short poolcounter;
 struct SWF_ACTIONPUSHPARAM *regs[256];
 
 static char *getName(struct SWF_ACTIONPUSHPARAM *act);
@@ -395,6 +396,11 @@
   		return t;
 #endif
 	case PUSH_CONSTANT: /* CONSTANT8 */
+		if (act->p.Constant8 > poolcounter)
+		{
+			SWF_warn("WARNING: retrieving constants not present in the pool.\n");
+			break;
+		}
 		t=malloc(strlenext(pool[act->p.Constant8])+1);
 		strcpyext(t,pool[act->p.Constant8]);
 		if(strlen(t)) /* Not a zero length string */
@@ -728,6 +734,7 @@
 {
 	OUT_BEGIN(SWF_ACTIONCONSTANTPOOL);
 	pool=sact->ConstantPool;
+	poolcounter=sact->Count;
 }
 
 static void
@@ -3411,7 +3418,7 @@
 		return NULL;
 
 	pool = NULL;
-
+	poolcounter=0;
 	dcinit();
 
 	for(j=0;j<256;j++) regs[j]=0;

```
### CVE-
1. report :
2. poc
3. target : 
4. stack strace
``` log



```
5. patch : 
